global
    maxconn 4096
    log 10.42.24.10:1514 local2

defaults
    log global
    timeout connect  5000
    timeout client  10000
    timeout server  10000

resolvers dns
    nameserver rancher 169.254.169.250:53
    hold valid 1s

listen statistics
    bind *:8008
    mode http
    stats enable
    stats uri /stats

listen postgres_rw
    bind *:5432
    mode tcp
    option tcp-smart-connect
    timeout client  {{ getenv "TIMEOUT" }}
    timeout server  {{ getenv "TIMEOUT" }}
    balance leastconn
{{range ls "/self/stack/services/postgres/containers"}}
    server {{.}} {{.}}:5432 resolvers dns check fastinter 1s
{{end}}

    option tcp-check

    # https://www.postgresql.org/docs/devel/static/protocol-message-formats.html can help you understand the following
    tcp-check send-binary 0000002f000300007573657200686561 # |.../....user.hea|
    tcp-check send-binary 6c7468636865636b0064617461626173 # |lthcheck.databas|
    tcp-check send-binary 65006865616c7468636865636b000051 # |e.healthcheck..Q|
    tcp-check send-binary 0000005353454c454354204341534520 # |...SSELECT CASE |
    tcp-check send-binary 5748454e2070675f69735f696e5f7265 # |WHEN pg_is_in_re|
    tcp-check send-binary 636f766572792829205448454e202769 # |covery() THEN 'i|
    tcp-check send-binary 5f616d5f736c6176652720454c534520 # |_am_slave' ELSE |
    tcp-check send-binary 27695f616d5f6d61737465722720454e # |'i_am_master' EN|
    tcp-check send-binary 443b005800000004                 # |D;.X....
    tcp-check comment     Query\ sent.\ Waiting\ response.
    tcp-check expect string i_am_master


listen postgres_ro
    bind *:5433
    mode tcp
    option tcp-smart-connect
    timeout client  10800s
    timeout server  10800s
    balance leastconn
{{range ls "/self/stack/services/postgres/containers"}}
    server {{.}} {{.}}:5432 resolvers dns check fastinter 1s
{{end}}
{{ if eq (getenv "RO_REPLICAS_ONLY") "true" }}
    option tcp-check

    # https://www.postgresql.org/docs/devel/static/protocol-message-formats.html can help you understand the following
    tcp-check send-binary 0000002f000300007573657200686561 # |.../....user.hea|
    tcp-check send-binary 6c7468636865636b0064617461626173 # |lthcheck.databas|
    tcp-check send-binary 65006865616c7468636865636b000051 # |e.healthcheck..Q|
    tcp-check send-binary 0000005353454c454354204341534520 # |...SSELECT CASE |
    tcp-check send-binary 5748454e2070675f69735f696e5f7265 # |WHEN pg_is_in_re|
    tcp-check send-binary 636f766572792829205448454e202769 # |covery() THEN 'i|
    tcp-check send-binary 5f616d5f736c6176652720454c534520 # |_am_slave' ELSE |
    tcp-check send-binary 27695f616d5f6d61737465722720454e # |'i_am_master' EN|
    tcp-check send-binary 443b005800000004                 # |D;.X....
    tcp-check comment     Query\ sent.\ Waiting\ response.
    tcp-check expect string i_am_slave
{{ else }}
    option pgsql-check user postgres
{{ end }}
